# Oracle Peoplesoft MAA Replication Scripts

     Version 1.0

Copyright (c) 2024 Oracle and/or its affiliates.

Released under the Universal Permissive License v1.0 as shown at
<https://oss.oracle.com/licenses/upl/>.


## Overview

Data Guard manages replication of data stored in the database from the primary site to the standby.  Certain file systems also need to be replicated â€“ the application and middle tier software, and the file-based output generated by the application programs.  The files holding output from application software need to be as close to in sync with the data inside the database as possible, so that if a site failover is required it is as easy as possible to resolve any differences between the state of data in the database and the reports and interfaces to other systems outside the database.
These rsync scripts replicate specific file systems from the primary to the standby, and manage the rsync direction through role transitions.  We honored these basic requirements in the design:
* Keep the file systems holding the relatively unchanging application and middle tier software current at the standby
* Keep the data for file-based output as up to date as we can at the standby
* Allow file system replication to continue while using the standby for snapshot standby tests

To accomplish this, we need:
* A pair of OCI compute instances.  This pair of compute instances must be able to access and mount the file systems being replicated.  In addition, this pair should not host or run any PeopleSoft components, only Oracle client software, including SQL*Plus.  To simplify your install, use the same Oracle client software that is used by PeopleSoft.
* This pair of OCI compute instances must have the psadm2 user created with the exact same uid and gid as the PeopleSoft middle tiers.  Otherwise, permission issues will be encountered.
* OCI command-line interface (CLI) must be installed and configured on this pair of compute instances and on all compute instances hosting the PeopleSoft application server and process scheduler.  

The rsync scripts will access the PeopleSoft database at the CDB level and will require the SYS password.  The OCI region-local vault service must be provisioned at each site / region to securely store these database credentials (secrets).

> [!IMPORTANT] 
* These scripts are built with the assumption that the PeopleSoft application and web tiers are deployed on shared file systems in OCI, e.g., on File System Service (FSS).
* The rsync scripts can run on the PeopleSoft application or web tiers, but doing so as normal practice prevents you from doing snapshot DR site testing, since the target "production" file systems would need to be unmounted.
* The startPSFTAPP.sh and stopPSFTAPP.sh wrapper scripts which run on the application tier compute instances, need to have access to the rsync scripts described here when performing a full stack switchover.
* Do not replicate anything under $PS_CFG_HOME, the COBOL run-time environment, or the COBOL license manager and its database.

## Design and Usage

The core replication of a given file system is done by a simple script that replicates the contents of a directory to a mirrored location at the standby site.
In our implementation, two replication scripts are deployed in order to manage the push of file system changes at a rate appropriate to the rate of change at the source - the report logging and output being kept as current as possible via frequent execution, and the relatively unchanging software image less frequently.  These scripts are executed as cron jobs.
The scripts are deployed at each region/site, and are designed to be running at both sites.  The script's behavior depends on whether the rsync process is enabled or disabled, and whether the site is in the PRIMARY or STANDBY role.  These scripts respond to role transitions and automatically change the direction of the replication.
The main replication scripts are:
* [enable_psft_rsync.sh](./enable_psft_rsync.sh)
* [disable_psft_rsync.sh](./disable_psft_rsync.sh)
* [rsync_psft.sh](./rsync_psft.sh)

There is an environment file called psrsync.env at each site that the rsync scripts use, to limit the need for hard coding.  The SCRIPT_DIR environment variable may also be defined in the PeopleSoft env file psft.env.  The psrsync.env contains the following:

<pre>
SCRIPT_DIR=< path to directory containing the replication scripts >
LOG_DIR=${SCRIPT_DIR}/log
USER=< file system owner - typically psadm2 >
PS_APP_DOMAIN=< PeopleSoft application server domain (Tuxedo domain name for the applicaiton server) >
PS_PRC_DOMAIN=< PeopleSoft process scheduler server domain (Tuxedo domain name for the process scheduler) >
PS_PIA_DOMAIN=< PeopleSoft PIA domain (Weblogic domain name for the PIA web server) >
TNS_CONNECT_STRING=< TNS connect string alias to the PeopleSoft database at the local site >
TARGET_HOST=< IP address of remote rsync host >
COMPARTMENT_OCID=< OCID of compartment containing the region-local vault >
SECRET_NAME="< name of secret within region-local vault >"
</pre>

There is a second set of environment files used to specify the directory structure being replicated and the name of the file where execution information will be logged.  The name of this log file will be passed in as a parameter to the enable / disable scripts as well as to the rsync_psft.sh script.  This file contains:

<pre>
FS_ALIAS=< short name / alias for this file system for example, fs1 >
LOG_FILE_NAME=< file to write rsync execution log info to, in $LOG_DIR >
SOURCE_RSYNC_DIR=< name of directory to replicate >
TARGET_RSYNC_DIR=< name of target directory to write to >
</pre>

On our system, we have two file systems we are replicating, thus two of these second environment files.  Our file fs1 holds:
<pre>
FS_ALIAS=fs1
LOG_FILE_NAME=fs1_psft_rsync.log
SOURCE_RSYNC_DIR=/u02/app/psft/ps
TARGET_RSYNC_DIR=/u02/app/psft/ps
</pre>
Our file fs2 holds:
<pre>
FS_ALIAS=fs2
LOG_FILE_NAME=fs2_psft_rsync.log
SOURCE_RSYNC_DIR=/u01/app/psft/pt
TARGET_RSYNC_DIR=/u01/app/psft/pt
</pre>
The replication scripts require the name of this run-specific environment file to be passed in on the command line for example:

> $ ./enable_psft_rsync.sh /< path >/fs1
 
The replication scripts call these additional scripts:

* [get_site_role.sh](./get_site_role.sh)
* [get_db_session_count.sh](./get_db_session_count.sh)

The get_site_role.sh script queries the database to determine the site role, which is used for determining replication direction. It uses the OCI CLI and SQL*Plus from the Oracle client software to access the PeopleSoft database at the local site.  The get_db_session_count.sh script is used to determine when all PeopleSoft application and process scheduler sessions have shut down, also using OCI cli.  This script is called by the stopPSFTAPP.sh script.

## Example Cron Job Entries

The cron job entries run the rsync_psft.sh at a specific time or frequency and for a specific file system as defined above.  The cron job entries need to be configured at both the primary and standby sites.  As described in the PeopleSoft Playbook, the rsync_psft.sh script will continiously run at both sites but the script will only replicate in one direction based on which site is in the primary role.  In the example below, we are replicating two FSS file systems:

* /u02/app/psft/ps, defined in the file fs1, that contains job logs and the report repository.
* /u01/app/psft/pt, defined in the file fs2, that contains the PeopleSoft PeopleTools software installation.

The file system for fs1 needs to match the contents of the database as closely as possible, thus needs to have a higher frequency of replication.  In the below crontab entry, it is set to every 5 minutes (*/5) for the minutes column.
The file system for fs2 is more static and is set up to replicate once a day, at 2:00 AM (0 2).

<pre>
*/5 * * * * psadm2 /u01/app/psft/pt/custom_admin_scripts/rsync_psft.sh /u01/app/psft/pt/custom_admin_scripts/fs1
0 2 * * * psadm2 /u01/app/psft/pt/custom_admin_scripts/rsync_psft.sh /u01/app/psft/pt/custom_admin_scripts/fs2
</pre>

